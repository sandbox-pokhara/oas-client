from typing import Any
from urllib.parse import urlencode


import httpx

from . import params
from . import queries
from . import requests
from . import responses


class APIClient(httpx.Client):
    def __init__(self, base_url: str, token: str | None = None, **kwargs: Any):
        headers = {
            "Accept": "application/json",
            "Content-Type": "application/json",
        }
        if token:
            headers["Authorization"] = f"Bearer {token}"

        super().__init__(base_url=base_url, headers=headers, **kwargs)

    {% for func in functions %}
    def {{ func.func_name }}(self{% if func.params %}, params: {{ func.params }}{% endif %}{% if func.query %}, query: {{ func.query }}{% endif %}{% if func.body %}, body: {{ func.body }}{% endif %}, **kwargs: Any) -> tuple[httpx.Response, {{ func.return }}]:
        url = "{{ func.url }}"
        {% if func.params %}
        url = url.format(**params)
        {% endif %}
        {% if func.query %}
        if query:
            url += "?" + urlencode(query)
        {% endif %}
        response = self.request(
            "{{ func.http_method }}",
            url{% if func.body %}, json=body{% endif %},
            **kwargs
        )
        return response, response.json()

    {% endfor %}
